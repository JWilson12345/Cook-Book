<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bodybuilding Recipe App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    .fade-down {
      animation: fadeDown 0.5s ease-out forwards;
    }
    @keyframes fadeDown {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    .slide-up {
      animation: slideUp 0.5s ease-out forwards;
    }
    @keyframes slideUp {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-100%);
      }
    }
    .fade-out {
      animation: fadeOut 0.3s ease-out forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .scale-transition {
      transition: transform 0.2s ease;
    }
    .scale-transition:hover {
      transform: scale(1.1);
    }
    .slide-grid {
      transition: transform 0.5s ease-out;
    }
    .dark {
      background: linear-gradient(135deg, #1a202c, #2d3748);
    }
    .light {
      background: #a8a8a8; /* gray-100 */
    }
    .app-container {
      min-height: 100vh; /* Ensure background fills device screen */
      display: flex;
      flex-direction: column;
    }
    .content {
      flex: 1 0 auto; /* Allow content to grow and fill space */
      overflow-y: auto;
    }
    .grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.75rem;
    }
    .grid-view > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .grid-view > div {
      background-color: #2d3748;
    }
    .light .grid-view > div {
      background-color: #efefef;
    }
    .dark .grid-view > div:hover {
      background-color: #4a5568;
    }
    .light .grid-view > div:hover {
      background-color: #dadada;
    }
    .grid-view img {
      width: 20vw;
      height: 20vw;
      max-width: 5rem;
      max-height: 5rem;
      object-fit: contain;
    }
    .grid-view span {
      font-size: clamp(0.75rem, 3vw, 0.875rem);
      margin-top: 0.5rem;
    }
    .dark .grid-view span {
      color: #ffffff;
    }
    .light .grid-view span {
      color: #111827;
    }
    .meal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.75rem;
    }
    .meal-grid > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem;
      padding-bottom: 2.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      min-height: 10rem;
      transition: transform 0.5s ease-out;
    }
    .dark .meal-grid > div {
      background-color: #2d3748;
    }
    .light .meal-grid > div {
      background-color: #e5e7eb;
    }
    .dark .meal-grid > div:hover {
      background-color: #4a5568;
    }
    .light .meal-grid > div:hover {
      background-color: #d1d5db;
    }
    .meal-grid img {
      width: 20vw;
      height: 20vw;
      max-width: 5rem;
      max-height: 5rem;
      object-fit: contain;
    }
    .meal-grid span {
      font-size: clamp(0.75rem, 3vw, 0.875rem);
      margin-top: 0.5rem;
    }
    .dark .meal-grid span {
      color: #ffffff;
    }
    .light .meal-grid span {
      color: #111827;
    }
    .meal-grid button {
      margin-top: 0.5rem;
      font-size: clamp(0.75rem, 3vw, 0.875rem);
    }
    .toast {
      position: fixed;
      bottom: 12rem; /* Adjusted to clear bug report and changelog sections */
      left: 50%;
      transform: translateX(-50%);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
      max-width: 90vw;
    }
    .dark .toast {
      background-color: #2d3748;
      color: #ffffff;
    }
    .light .toast {
      background-color: #e5e7eb;
      color: #111827;
    }
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      margin: 1rem 0;
    }
    .search-clear {
      position: absolute;
      right: 3rem;
    }
    .search-info {
      position: absolute;
      right: 0;
    }
    .changelog-container {
      flex-shrink: 0; /* Prevent changelog from shrinking */
      width: 100%;
      max-width: 90vw;
      margin: 0 auto;
      padding: 1rem 0;
    }
    .bug-report-container {
      flex-shrink: 0; /* Prevent bug report section from shrinking */
      width: 100%;
      max-width: 90vw;
      margin: 0 auto;
      padding: 1rem 0;
    }
    .changelog-list {
      padding-left: 1.5rem;
    }
    .changelog-list > li {
      margin-bottom: 0.5rem;
    }
    .changelog-list .added {
      color: #10b981; /* Emerald green */
      list-style-type: "➕ ";
    }
    .changelog-list .removed {
      color: #ef4444; /* Red */
      list-style-type: "➖ ";
    }
    .changelog-close {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 60;
    }
    .tag-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tag-label {
      display: flex;
      align-items: center;
      font-size: clamp(0.75rem, 3vw, 0.875rem);
    }
  </style>
</head>
<body class="dark">
  <div id="root"></div>
  <script src="recipes.js"></script>
  <script type="text/babel">
    const App = () => {
      const [mealPlan, setMealPlan] = React.useState(() => {
        const saved = localStorage.getItem('mealPlan');
        return saved ? JSON.parse(saved) : [];
      });
      const [showPopup, setShowPopup] = React.useState(false);
      const [currentRecipe, setCurrentRecipe] = React.useState(null);
      const [quantity, setQuantity] = React.useState(1);
      const [showResetConfirm, setShowResetConfirm] = React.useState(false);
      const [showMealPlan, setShowMealPlan] = React.useState(false);
      const [showPreparedPopup, setShowPreparedPopup] = React.useState(null);
      const [showInfoPopup, setShowInfoPopup] = React.useState(false);
      const [showRecipeInfoPopup, setShowRecipeInfoPopup] = React.useState(false);
      const [showMealPlanInfoPopup, setShowMealPlanInfoPopup] = React.useState(false);
      const [showPreparedInfoPopup, setShowPreparedInfoPopup] = React.useState(false);
      const [showResetInfoPopup, setShowResetInfoPopup] = React.useState(false);
      const [showSearchInfoPopup, setShowSearchInfoPopup] = React.useState(false);
      const [showChangelogPopup, setShowChangelogPopup] = React.useState(false);
      const [fadingItemIndex, setFadingItemIndex] = React.useState(null);
      const [slidingItems, setSlidingItems] = React.useState([]);
      const [isClosingPopup, setIsClosingPopup] = React.useState(false);
      const [isClosingPreparedPopup, setIsClosingPreparedPopup] = React.useState(false);
      const [isClosingResetPopup, setIsClosingResetPopup] = React.useState(false);
      const [isClosingInfoPopup, setIsClosingInfoPopup] = React.useState(false);
      const [isClosingRecipeInfoPopup, setIsClosingRecipeInfoPopup] = React.useState(false);
      const [isClosingMealPlanInfoPopup, setIsClosingMealPlanInfoPopup] = React.useState(false);
      const [isClosingPreparedInfoPopup, setIsClosingPreparedInfoPopup] = React.useState(false);
      const [isClosingResetInfoPopup, setIsClosingResetInfoPopup] = React.useState(false);
      const [isClosingSearchInfoPopup, setIsClosingSearchInfoPopup] = React.useState(false);
      const [isClosingChangelogPopup, setIsClosingChangelogPopup] = React.useState(false);
      const [isGridView, setIsGridView] = React.useState(false);
      const [isDarkMode, setIsDarkMode] = React.useState(() => {
        const saved = localStorage.getItem('isDarkMode');
        return saved !== null ? JSON.parse(saved) : true;
      });
      const [searchQuery, setSearchQuery] = React.useState('');
      const [selectedTags, setSelectedTags] = React.useState([]);
      const [showToast, setShowToast] = React.useState(false);
      const [lastAction, setLastAction] = React.useState(null);
      const [bugReport, setBugReport] = React.useState('');

      React.useEffect(() => {
        localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
      }, [mealPlan]);

      React.useEffect(() => {
        localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
        document.body.className = isDarkMode ? 'dark' : 'light';
      }, [isDarkMode]);

      React.useEffect(() => {
        if (showToast) {
          const timer = setTimeout(() => {
            setShowToast(false);
            setLastAction(null);
          }, 5000);
          return () => clearTimeout(timer);
        }
      }, [showToast]);

      const uniqueTags = [...new Set(recipes.flatMap(r => r.tags || []))];

      const toggleTag = (tag) => {
        setSelectedTags(prev => 
          prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]
        );
      };

      const findRecipeByName = (name) => recipes.find(r => r.name === name);

      const addToMealPlan = () => {
        const existingItem = mealPlan.find(item => item.recipe === currentRecipe.name && !item.prepared);
        if (existingItem) {
          const updatedPlan = mealPlan.map(item =>
            item.recipe === currentRecipe.name && !item.prepared
              ? { ...item, quantity: item.quantity + quantity }
              : item
          );
          setMealPlan(updatedPlan);
        } else {
          setMealPlan([...mealPlan, { recipe: currentRecipe.name, quantity, prepared: false }]);
        }
        setIsClosingPopup(true);
        setTimeout(() => {
          setShowPopup(false);
          setIsClosingPopup(false);
          setQuantity(1);
          setShowMealPlan(true); // Navigate to meal plan page after adding
        }, 300);
      };

      const confirmPrepared = (index) => {
        setFadingItemIndex(index);
        const item = mealPlan[index];
        setLastAction({ type: 'prepared', data: { ...item, index } });
        setShowToast(true);
        const itemsToSlide = isGridView ? [] : mealPlan.filter((item, i) => i > index && !item.prepared).map((_, i) => index + i + 1);
        setSlidingItems(itemsToSlide);
        setTimeout(() => {
          const updatedPlan = [...mealPlan];
          updatedPlan[index].prepared = true;
          setMealPlan(updatedPlan.filter(item => !item.prepared));
          setFadingItemIndex(null);
          setSlidingItems([]);
        }, 500);
        setIsClosingPreparedPopup(true);
        setTimeout(() => {
          setShowPreparedPopup(null);
          setIsClosingPreparedPopup(false);
        }, 300);
      };

      const resetPlan = () => {
        setLastAction({ type: 'reset', data: [...mealPlan] });
        setShowToast(true);
        setMealPlan([]);
        setIsClosingResetPopup(true);
        setTimeout(() => {
          setShowResetConfirm(false);
          setIsClosingResetPopup(false);
        }, 300);
      };

      const undoAction = () => {
        if (lastAction?.type === 'prepared') {
          const { data } = lastAction;
          const updatedPlan = [...mealPlan];
          updatedPlan.splice(data.index, 0, { ...data, prepared: false });
          setMealPlan(updatedPlan);
        } else if (lastAction?.type === 'reset') {
          setMealPlan(lastAction.data);
        }
        setShowToast(false);
        setLastAction(null);
      };

      const clearSearch = () => {
        setSearchQuery('');
      };

      const submitBugReport = () => {
        if (!bugReport.trim()) {
          setShowToast(true);
          setLastAction({ type: 'bug-report-error', data: 'Bug report cannot be empty.' });
          setTimeout(() => {
            setShowToast(false);
            setLastAction(null);
          }, 5000);
          return;
        }

        emailjs.send('service_637q56m', 'template_9hu2bkl', {
          message: bugReport,
          from_email: 'jacobfazer1@gmail.com',
          to_email: 'jacobfazer1@gmail.com'
        }, 'iPjziLz6-ui5TluiZ')
          .then(() => {
            setShowToast(true);
            setLastAction({ type: 'bug-report-success', data: 'Bug report sent successfully.' });
            setBugReport('');
            setTimeout(() => {
              setShowToast(false);
              setLastAction(null);
            }, 5000);
          }, (error) => {
            setShowToast(true);
            setLastAction({ type: 'bug-report-error', data: 'Failed to send bug report.' });
            setTimeout(() => {
              setShowToast(false);
              setLastAction(null);
            }, 5000);
          });
      };

      const toggleInfoPopup = () => {
        if (showInfoPopup) {
          setIsClosingInfoPopup(true);
          setTimeout(() => {
            setShowInfoPopup(false);
            setIsClosingInfoPopup(false);
          }, 300);
        } else {
          setShowInfoPopup(true);
        }
      };

      const toggleRecipeInfoPopup = () => {
        if (showRecipeInfoPopup) {
          setIsClosingRecipeInfoPopup(true);
          setTimeout(() => {
            setShowRecipeInfoPopup(false);
            setIsClosingRecipeInfoPopup(false);
          }, 300);
        } else {
          setShowRecipeInfoPopup(true);
        }
      };

      const toggleMealPlanInfoPopup = () => {
        if (showMealPlanInfoPopup) {
          setIsClosingMealPlanInfoPopup(true);
          setTimeout(() => {
            setShowMealPlanInfoPopup(false);
            setIsClosingMealPlanInfoPopup(false);
          }, 300);
        } else {
          setShowMealPlanInfoPopup(true);
        }
      };

      const togglePreparedInfoPopup = () => {
        if (showPreparedInfoPopup) {
          setIsClosingPreparedInfoPopup(true);
          setTimeout(() => {
            setShowPreparedInfoPopup(false);
            setIsClosingPreparedInfoPopup(false);
          }, 300);
        } else {
          setShowPreparedInfoPopup(true);
        }
      };

      const toggleResetInfoPopup = () => {
        if (showResetInfoPopup) {
          setIsClosingResetInfoPopup(true);
          setTimeout(() => {
            setShowResetInfoPopup(false);
            setIsClosingResetInfoPopup(false);
          }, 300);
        } else {
          setShowResetInfoPopup(true);
        }
      };

      const toggleSearchInfoPopup = () => {
        if (showSearchInfoPopup) {
          setIsClosingSearchInfoPopup(true);
          setTimeout(() => {
            setShowSearchInfoPopup(false);
            setIsClosingSearchInfoPopup(false);
          }, 300);
        } else {
          setShowSearchInfoPopup(true);
        }
      };

      const toggleChangelogPopup = () => {
        if (showChangelogPopup) {
          setIsClosingChangelogPopup(true);
          setTimeout(() => {
            setShowChangelogPopup(false);
            setIsClosingChangelogPopup(false);
          }, 300);
        } else {
          setShowChangelogPopup(true);
        }
      };

      const toggleView = () => {
        setIsGridView(!isGridView);
      };

      const toggleTheme = () => {
        setIsDarkMode(!isDarkMode);
      };

      const filteredRecipes = recipes.filter(recipe =>
        recipe.name.toLowerCase().includes(searchQuery.toLowerCase()) &&
        (selectedTags.length === 0 || selectedTags.some(tag => recipe.tags?.includes(tag)))
      );

      const totalPortions = mealPlan.reduce((sum, item) => sum + item.quantity, 0);

      return (
        <div className="app-container">
          <header className="w-full max-w-[90vw] mx-auto mb-6">
            <div className="flex items-center justify-between mb-4">
              <h1 className={`text-[clamp(1.5rem,5vw,2rem)] font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Bodybuilding Recipe App</h1>
              <div className="flex space-x-2">
                <button
                  onClick={toggleInfoPopup}
                  className="w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                  aria-label="Info"
                >
                  ?
                </button>
                <button
                  onClick={toggleView}
                  className="w-10 h-10 rounded-full bg-blue-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-blue-600 scale-transition"
                  aria-label="Toggle view"
                >
                  <i className={`fas ${isGridView ? 'fa-bars' : 'fa-th'}`}></i>
                </button>
                <button
                  onClick={toggleTheme}
                  className="w-10 h-10 rounded-full bg-blue-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-blue-600 scale-transition"
                  aria-label="Toggle theme"
                >
                  <i className={`fas ${isDarkMode ? 'fa-moon' : 'fa-sun'}`}></i>
                </button>
              </div>
            </div>
            <div className="flex justify-between mb-4 gap-2">
              <button
                onClick={() => setShowMealPlan(false)}
                className={`flex-1 py-2 rounded-lg font-semibold text-white shadow-md hover:bg-gray-600 ${
                  !showMealPlan ? (isDarkMode ? 'bg-blue-700' : 'bg-blue-600') : (isDarkMode ? 'bg-gray-700' : 'bg-gray-400')
                }`}
              >
                Browse Recipes
              </button>
              <button
                onClick={() => setShowMealPlan(true)}
                className={`flex-1 py-2 rounded-lg font-semibold text-white shadow-md hover:bg-gray-600 ${
                  showMealPlan ? (isDarkMode ? 'bg-blue-700' : 'bg-blue-600') : (isDarkMode ? 'bg-gray-700' : 'bg-gray-400')
                }`}
              >
                Meal Plan
              </button>
            </div>
          </header>

          <main className="content">
            <div className="w-full max-w-[90vw] mx-auto">
              {showMealPlan ? (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center">
                      <h2 className={`text-[clamp(1.25rem,4vw,1.5rem)] font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Meal Plan</h2>
                      <button
                        onClick={toggleMealPlanInfoPopup}
                        className="ml-3 w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                        aria-label="Meal plan info"
                      >
                        ?
                      </button>
                    </div>
                    <button
                      onClick={() => setShowResetConfirm(true)}
                      className="px-4 py-2 bg-red-700 text-white rounded-lg shadow-md hover:bg-red-600 text-[clamp(0.875rem,3vw,1rem)]"
                    >
                      Reset Plan
                    </button>
                  </div>
                  <p className={`text-[clamp(1rem,4vw,1.125rem)] font-semibold mb-4 ${isDarkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                    Total Portions: {totalPortions}
                  </p>
                  {mealPlan.length === 0 ? (
                    <p className={`text-center ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>No meals in plan.</p>
                  ) : (
                    <div className={isGridView ? 'meal-grid' : 'space-y-3'}>
                      {mealPlan.filter(item => !item.prepared).map((item, index) => (
                        <div
                          key={index}
                          className={`flex ${isGridView ? 'slide-grid' : 'items-center justify-between p-3 rounded-lg meal-item shadow-md'} ${
                            fadingItemIndex === index ? 'fade-down' : isGridView ? '' : slidingItems.includes(index) ? 'slide-up' : ''
                          } ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                        >
                          <div className={isGridView ? '' : 'flex items-center'}>
                            <img
                              src={`images/${item.recipe.replace(/ /g, '_')}.png`}
                              alt={item.recipe}
                              className={isGridView ? '' : 'w-[20vw] h-[20vw] max-w-24 max-h-24 mr-4 object-contain'}
                              onError={(e) => { e.target.src = 'https://via.placeholder.com/150'; }}
                            />
                            <span className={isGridView ? '' : `ml-4 text-[clamp(1rem,4vw,1.125rem)] ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                              {item.recipe} (x{item.quantity})
                            </span>
                          </div>
                          {!isGridView && (
                            <button
                              onClick={() => setShowPreparedPopup(mealPlan.findIndex(i => i.recipe === item.recipe && i.quantity === item.quantity && !i.prepared))}
                              className="px-4 py-2 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-600 text-[clamp(0.875rem,3vw,1rem)]"
                            >
                              View
                            </button>
                          )}
                          {isGridView && (
                            <button
                              onClick={() => setShowPreparedPopup(mealPlan.findIndex(i => i.recipe === item.recipe && i.quantity === item.quantity && !i.prepared))}
                              className="mt-2 px-3 py-1.5 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-600 text-[clamp(0.75rem,3vw,0.875rem)]"
                            >
                              View
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ) : (
                <div>
                  <div className="search-container">
                    <input
                      type="text"
                      placeholder="Search recipes..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className={`w-[calc(100%-8rem)] p-2 border rounded-lg ${isDarkMode ? 'bg-gray-700 text-white placeholder-gray-400 border-gray-600' : 'bg-gray-200 text-gray-900 placeholder-gray-500 border-gray-300'}`}
                      aria-label="Search recipes"
                    />
                    <button
                      onClick={clearSearch}
                      className="search-clear w-10 h-10 rounded-full bg-red-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-red-600 scale-transition"
                      aria-label="Clear search"
                    >
                      <i className="fas fa-times"></i>
                    </button>
                    <button
                      onClick={toggleSearchInfoPopup}
                      className="search-info w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                      aria-label="Search info"
                    >
                      ?
                    </button>
                  </div>
                  <div className="tag-filter">
                    {uniqueTags.map(tag => (
                      <label key={tag} className={`tag-label ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                        <input
                          type="checkbox"
                          checked={selectedTags.includes(tag)}
                          onChange={() => toggleTag(tag)}
                          className="mr-1"
                        />
                        {tag}
                      </label>
                    ))}
                  </div>
                  <div className={`pt-4 ${isGridView ? 'grid-view' : 'grid gap-3'}`}>
                    {filteredRecipes.length === 0 ? (
                      <p className={`text-center ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>No recipes found.</p>
                    ) : (
                      filteredRecipes.map((recipe) => (
                        <div
                          key={recipe.id || recipe.name}
                          className={`flex ${isGridView ? '' : 'items-center p-3 rounded-lg shadow-lg'} ${
                            isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-200 hover:bg-gray-300'
                          }`}
                          onClick={() => {
                            setCurrentRecipe(recipe);
                            setShowPopup(true);
                          }}
                        >
                          <img
                            src={`images/${recipe.name.replace(/ /g, '_')}.png`}
                            alt={recipe.name}
                            className={isGridView ? '' : 'w-[20vw] h-[20vw] max-w-24 max-h-24 mr-4 object-contain'}
                            onError={(e) => { e.target.src = 'https://via.placeholder.com/150'; }}
                          />
                          <span className={isGridView ? '' : `text-[clamp(1rem,4vw,1.125rem)] font-medium ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                            {recipe.name}
                          </span>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>
          </main>

          <div className="bug-report-container">
            <h3 className={`text-[clamp(1.25rem,4vw,1.5rem)] font-semibold mb-4 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Report a Bug</h3>
            <textarea
              value={bugReport}
              onChange={(e) => setBugReport(e.target.value)}
              placeholder="Describe the bug or issue..."
              className={`w-full p-2 border rounded-lg mb-4 ${isDarkMode ? 'bg-gray-700 text-white placeholder-gray-400 border-gray-600' : 'bg-gray-200 text-gray-900 placeholder-gray-500 border-gray-300'}`}
              rows="4"
              aria-label="Bug report"
            ></textarea>
            <div className="flex justify-end">
              <button
                onClick={submitBugReport}
                className="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
              >
                Submit
              </button>
            </div>
          </div>

          <div className="changelog-container">
            <button
              onClick={toggleChangelogPopup}
              className={`underline mb-4 ${isDarkMode ? 'text-gray-200 hover:text-blue-500' : 'text-gray-600 hover:text-blue-500'}`}
            >
              Changelog
            </button>
            <span className={isDarkMode ? 'text-gray-200' : 'text-gray-600'}>V1.0</span>
          </div>

          {showPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center ${isClosingPopup ? 'fade-out' : 'fade-in'}`}
              onClick={() => {
                setIsClosingPopup(true);
                setTimeout(() => {
                  setShowPopup(false);
                  setIsClosingPopup(false);
                  setQuantity(1);
                }, 300);
              }}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg relative overflow-y-auto max-h-[80vh] ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <button
                  onClick={toggleRecipeInfoPopup}
                  className="absolute top-2 right-2 w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                  aria-label="Recipe info"
                >
                  ?
                </button>
                <div className="flex items-center mb-4">
                  <img
                    src={`images/${currentRecipe.name.replace(/ /g, '_')}.png`}
                    alt={currentRecipe.name}
                    className="w-[20vw] h-[20vw] max-w-24 max-h-24 mr-4 object-contain"
                    onError={(e) => { e.target.src = 'https://via.placeholder.com/150'; }}
                  />
                  <h2 className={`text-[clamp(1rem,4vw,1.125rem)] font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{currentRecipe.name}</h2>
                </div>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Prep Time: {currentRecipe.prepTime}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Cook Time: {currentRecipe.cookTime}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Ingredients: {currentRecipe.ingredients}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] whitespace-pre-line ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Recipe: {currentRecipe.recipe}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Macros: {currentRecipe.macros}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Calories: {currentRecipe.calories}</p>
                <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Insights: {currentRecipe.insights}</p>
                <div className="flex items-center mb-4 mt-4">
                  <button
                    onClick={() => setQuantity(Math.max(1, quantity - 1))}
                    className="px-4 py-2 bg-gray-600 text-white rounded-lg scale-transition shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                    aria-label="Decrease quantity"
                  >
                    -
                  </button>
                  <input
                    type="number"
                    value={quantity}
                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                    className={`mx-4 w-16 text-center border rounded-lg ${isDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-gray-300 text-gray-900 border-gray-400'}`}
                    aria-label="Quantity"
                  />
                  <button
                    onClick={() => setQuantity(quantity + 1)}
                    className="px-4 py-2 bg-gray-600 text-white rounded-lg scale-transition shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                    aria-label="Increase quantity"
                  >
                    +
                  </button>
                </div>
                <div className="flex justify-end space-x-2">
                  <button
                    onClick={() => {
                      setIsClosingPopup(true);
                      setTimeout(() => {
                        setShowPopup(false);
                        setIsClosingPopup(false);
                        setQuantity(1);
                      }, 300);
                    }}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-400 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={addToMealPlan}
                    className="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Add to Meal Plan
                  </button>
                </div>
              </div>
            </div>
          )}

          {showResetConfirm && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center ${isClosingResetPopup ? 'fade-out' : 'fade-in'}`}
              onClick={() => {
                setIsClosingResetPopup(true);
                setTimeout(() => {
                  setShowResetConfirm(false);
                  setIsClosingResetPopup(false);
                }, 300);
              }}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg relative ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <button
                  onClick={toggleResetInfoPopup}
                  className="absolute top-2 right-2 w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                  aria-label="Reset info"
                >
                  ?
                </button>
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Are you sure you want to reset the meal plan?</p>
                <div className="flex justify-end space-x-2">
                  <button
                    onClick={() => {
                      setIsClosingResetPopup(true);
                      setTimeout(() => {
                        setShowResetConfirm(false);
                        setIsClosingResetPopup(false);
                      }, 300);
                    }}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-400 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={resetPlan}
                    className="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Reset
                  </button>
                </div>
              </div>
            </div>
          )}

          {showPreparedPopup !== null && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center ${isClosingPreparedPopup ? 'fade-out' : 'fade-in'}`}
              onClick={() => {
                setIsClosingPreparedPopup(true);
                setTimeout(() => {
                  setShowPreparedPopup(null);
                  setIsClosingPreparedPopup(false);
                }, 300);
              }}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg relative overflow-y-auto max-h-[80vh] ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <button
                  onClick={togglePreparedInfoPopup}
                  className="absolute top-2 right-2 w-10 h-10 rounded-full bg-green-700 text-white flex items-center justify-center text-lg font-semibold hover:bg-green-600 scale-transition"
                  aria-label="Prepared info"
                >
                  ?
                </button>
                {(() => {
                  const item = mealPlan[showPreparedPopup];
                  const recipe = findRecipeByName(item.recipe);
                  return (
                    <>
                      <h2 className={`text-[clamp(1rem,4vw,1.125rem)] font-semibold mb-4 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{item.recipe} (x{item.quantity})</h2>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Prep Time: {recipe.prepTime}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Cook Time: {recipe.cookTime}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Ingredients: {recipe.ingredients}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] whitespace-pre-line ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Recipe: {recipe.recipe}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Macros: {recipe.macros}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Calories: {recipe.calories}</p>
                      <p className={`text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>Insights: {recipe.insights}</p>
                    </>
                  );
                })()}
                <div className="flex justify-end space-x-2 mt-4">
                  <button
                    onClick={() => {
                      setIsClosingPreparedPopup(true);
                      setTimeout(() => {
                        setShowPreparedPopup(null);
                        setIsClosingPreparedPopup(false);
                      }, 300);
                    }}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-400 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => confirmPrepared(showPreparedPopup)}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Mark as Prepared
                  </button>
                </div>
              </div>
            </div>
          )}

          {showInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  Browse recipes and add them to your meal plan. View and mark meals as prepared in the Meal Plan tab. Filter by tags like 'protein', 'carbs'. Toggle dark/light mode for better visibility. The Bug Report and Change Log sections appear at the bottom of the screen.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={toggleInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showRecipeInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingRecipeInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleRecipeInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  View recipe details. Use the +/- buttons to adjust portions. Confirm to add it to the meal plan. If the recipe is already in the plan, the portions will be added to the existing amount.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={toggleRecipeInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showMealPlanInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingMealPlanInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleMealPlanInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  View recipes in the meal plan. Click 'View' to see details and mark as prepared, or use 'Reset Plan' to clear all items. View the total number of portions.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={toggleMealPlanInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showPreparedInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingPreparedInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={togglePreparedInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  Confirming marks the meal as prepared, removing it from the meal plan. Undo an action within 5 seconds to restore the item.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={togglePreparedInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showResetInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingResetInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleResetInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  Resetting clears all items from the meal plan. Undo an action within 5 seconds to restore the plan.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={toggleResetInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showSearchInfoPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingSearchInfoPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleSearchInfoPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800' : 'bg-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <p className={`mb-4 text-[clamp(0.875rem,3vw,1rem)] ${isDarkMode ? 'text-gray-200' : 'text-gray-600'}`}>
                  Search to quickly find recipes by name. Use tag filters to narrow down by categories like 'protein' or 'carbs'.
                </p>
                <div className="flex justify-end">
                  <button
                    onClick={toggleSearchInfoPopup}
                    className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {showChangelogPopup && (
            <div
              className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center ${isClosingChangelogPopup ? 'fade-out' : 'fade-in'}`}
              onClick={toggleChangelogPopup}
            >
              <div
                className={`p-6 rounded-lg w-[90vw] max-w-md shadow-lg ${isDarkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200 text-gray-900'}`}
                onClick={(e) => e.stopPropagation()}
                style={{ maxHeight: '70vh', overflowY: 'auto' }}
              >
                <h3 className={`text-[clamp(1.25rem,4vw,1.5rem)] font-bold mb-4 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Changelog</h3>
                <div className="changelog-list">
                  <h4 className={`text-[clamp(1rem,3vw,1.125rem)] font-semibold mb-2 ${isDarkMode ? 'text-green-400' : 'text-green-600'}`}>Version 1.0</h4>
                  <ul>
                    <li className="added">Initial release for bodybuilding recipe app</li>
                    <li className="added">Recipe browsing with details popup</li>
                    <li className="added">Meal plan management</li>
                    <li className="added">Tag filtering for recipes</li>
                    <li className="added">Portion quantity support</li>
                  </ul>
                </div>
              </div>
              <button
                onClick={toggleChangelogPopup}
                className={`changelog-close px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 shadow-md text-[clamp(0.875rem,3vw,1rem)]`}
              >
                Close
              </button>
            </div>
          )}

          {showToast && (
            <div className={`toast flex items-center space-x-4 fade-in`}>
              <p className={`font-semibold text-[clamp(0.875rem,3vw,1rem)]`}>
                {lastAction?.type === 'prepared' ? 'Meal marked as prepared.' : 
                 lastAction?.type === 'reset' ? 'Meal plan reset.' : 
                 lastAction?.type === 'bug-report-success' ? lastAction.data : 
                 lastAction?.type === 'bug-report-error' ? lastAction.data : ''}
              </p>
              {lastAction?.type !== 'bug-report-success' && lastAction?.type !== 'bug-report-error' && (
                <button
                  onClick={undoAction}
                  className="px-3 py-1 bg-blue-700 text-white rounded-lg hover:bg-blue-600 shadow-md text-[clamp(0.75rem,3vw,0.875rem)]"
                >
                  Undo
                </button>
              )}
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>